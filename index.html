<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-IV SP Weight & Balance Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
            stroke-width: 1.5;
        }
        .time-input {
            width: 4rem;
        }
        .seat {
            border: 1px solid #4a5568;
            background-color: #2d3748;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            min-width: 50px;
        }
        .seat-input {
            width: 50px;
            background-color: #4a5568;
            border: 1px solid #718096;
            text-align: center;
            border-radius: 0.25rem;
        }
        .table-box {
            border: 2px solid #fdba74; /* Amber color to match theme */
            background-color: #4a5568;
            border-radius: 0.25rem;
            width: 20px;
            height: 20px;
            align-self: center;
        }
        .component {
            border: 1px solid #4a5568;
            background-color: #2d3748;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
        }
        .cg-table th, .cg-table td {
            padding: 0.5rem 0.25rem;
            text-align: right;
            font-size: 0.875rem;
            vertical-align: middle;
        }
        .cg-table th:first-child, .cg-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        .total-row {
            background-color: #1f2937;
            font-weight: bold;
            color: #fcd34d;
        }
        .editable-cell-input {
            width: 100%;
            background-color: #4a5568;
            border: 1px solid #718096;
            text-align: right;
            border-radius: 0.25rem;
            padding-right: 0.25rem;
        }
        input:read-only {
            background-color: #374151; /* A slightly different gray for readonly fields */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="login-page" class="flex flex-col items-center justify-center min-h-screen px-4">
        <h1 class="text-3xl font-bold text-white mb-8 text-center">Welcome to<span class="block text-amber-400 mt-2">Gulfstream IV PK-TWY Apps</span></h1>
        <div class="w-full max-w-sm p-6 bg-gray-800 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-white mb-6">Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                    <input type="text" id="username" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Login</button>
                <p id="login-error" class="text-red-400 text-sm mt-4 text-center hidden"></p>
            </form>
        </div>
    </div>

    <div id="admin-page" class="hidden container mx-auto max-w-lg p-4 sm:p-6 bg-gray-900 min-h-screen">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-white">Admin Settings</h1>
            <button id="admin-logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
            <h2 class="text-lg font-semibold text-white mb-4">Application Expiry Date</h2>
            <div class="flex items-center space-x-4">
                <label for="expiry-date-input" class="text-sm font-medium text-gray-300">Set Expiry Date:</label>
                <input type="date" id="expiry-date-input" class="bg-gray-700 text-white p-2 border border-gray-600 rounded-md">
            </div>
            <button id="save-expiry-btn" class="mt-6 bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Save Date</button>
            <p id="admin-message" class="text-green-400 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="expired-page" class="hidden flex items-center justify-center min-h-screen text-center">
        <div class="w-full max-w-md p-8 bg-gray-800 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-red-400 mb-4">Application Expired</h2>
            <p class="text-gray-300 mb-6">Please contact the administrator immediately to extend your application's active period.</p>
            <a href="https://wa.me/6281215917554" target="_blank" class="inline-flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.057.098-1.152 4.205 4.283-1.124.11.069z"/></svg>
                Contact via WhatsApp
            </a>
        </div>
    </div>

    <div id="app-page" class="hidden">
        <div class="container mx-auto max-w-lg p-4 sm:p-6 bg-gray-900 min-h-screen">
            <!-- Header -->
            <header class="text-center sticky top-0 bg-gray-900 z-10 py-4 mb-6 relative">
                <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-tight">G-IV SP Weight & Balance</h1>
                <p class="text-amber-400 font-semibold">PK-TWY</p>
                <p class="text-xs text-gray-500 mt-1">by SkyOps Solutions</p>
                <p id="expiry-date-display" class="text-xs text-red-400 mt-2"></p>
                <p id="expiry-countdown" class="text-xs text-amber-400 mt-1"></p>
                <button id="app-logout-btn" class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Logout</button>
            </header>

            <div id="main-content" class="space-y-6">
                
                <!-- Route Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Route</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="routeFrom" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                From (Example: WIHH)
                            </label>
                            <input type="text" id="routeFrom" class="w-48 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="routeTo" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M2 12h20"/><path d="m18 8-4 4 4 4"/><path d="m6 8 4 4-4 4"/></svg>
                                Destination (Example: WARR)
                            </label>
                            <input type="text" id="routeTo" class="w-48 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                    </div>
                </div>

                <!-- Aircraft Limits Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Aircraft Limits (lbs)</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="rampWeight" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M5 5a5 5 0 0 1 10 0v2A5 5 0 0 1 5 7V5Z"/><path d="M12 12a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0v-2a5 5 0 0 1 5-5Z"/></svg>
                                Ramp Weight
                            </label>
                            <input type="number" id="rampWeight" value="75000" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="maxTakeoffWeight" class="flex items-center text-sm font-medium">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M2 22h20"/><path d="M18.6 16.5a2.5 2.5 0 0 0-2-2.46l-5.6-1.55a2.5 2.5 0 0 0-2.8 2.22l-1.2 5.6a2.5 2.5 0 0 0 2.22 2.8l5.6 1.2a2.5 2.5 0 0 0 2.46-2L19 18.3a2 2 0 0 0-2-2.46Z"/><path d="m6.23 16.37 3.32-3.32"/><path d="m14 7 3-3 3 3-3 3Z"/></svg>
                                Max Takeoff Weight
                            </label>
                            <input type="number" id="maxTakeoffWeight" value="74600" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                    </div>
                </div>

                <!-- Payload Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Aircraft & Payload Data</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="emptyWeight" class="flex items-center text-sm font-medium">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M15.2 3.2a1 1 0 0 0-1.4 1.4L15.2 6l-2.3 2.3a1 1 0 1 0 1.4 1.4l2.3-2.3 1.4 1.4a1 1 0 0 0 1.4-1.4L18 6l1.4-1.4a1 1 0 0 0-1.4-1.4L16.6 4.8 15.2 3.2z"/><path d="m10.2 6.8 4 4"/><path d="m6.8 10.2 4 4"/><path d="m14 19.5 4.9-11.4L2.5 2.5 14 19.5z"/></svg>
                                Empty Weight (lbs)
                            </label>
                            <input type="number" id="emptyWeight" value="43743" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="picName" class="flex items-center text-sm font-medium">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                                PIC Name
                            </label>
                            <input list="pic-names" id="picName" name="picName" class="w-48 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="pilot" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M5 5a5 5 0 0 1 10 0v2A5 5 0 0 1 5 7V5Z"/><path d="M12 12a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0v-2a5 5 0 0 1 5-5Z"/></svg>
                                Pilot (kg)
                            </label>
                            <input type="number" id="pilot" value="90" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="copilotName" class="flex items-center text-sm font-medium">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                                Copilot Name
                            </label>
                            <input list="copilot-names" id="copilotName" name="copilotName" class="w-48 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="copilot" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M5 5a5 5 0 0 1 10 0v2A5 5 0 0 1 5 7V5Z"/><path d="M12 12a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0v-2a5 5 0 0 1 5-5Z"/></svg>
                                Copilot (kg)
                            </label>
                            <input type="number" id="copilot" value="90" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="engineerName" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                                Engineer Name
                            </label>
                            <input list="engineer-names" id="engineerName" name="engineerName" class="w-48 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="engineer" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M5 5a5 5 0 0 1 10 0v2A5 5 0 0 1 5 7V5Z"/><path d="M12 12a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0v-2a5 5 0 0 1 5-5Z"/></svg>
                                Engineer (kg)
                            </label>
                            <input type="number" id="engineer" value="90" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="cabinServiceName" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                                Cabin Service Name
                            </label>
                            <input list="cabin-service-names" id="cabinServiceName" name="cabinServiceName" class="w-48 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="cabinService" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M5 5a5 5 0 0 1 10 0v2A5 5 0 0 1 5 7V5Z"/><path d="M12 12a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0v-2a5 5 0 0 1 5-5Z"/></svg>
                                Cabin Service (kg)
                            </label>
                            <input type="number" id="cabinService" value="90" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="totalPob" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Total Person on Board (POB)
                            </label>
                            <input type="number" id="totalPob" placeholder="0" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="baggage" class="flex items-center text-sm font-medium">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M8 6h8"/><path d="M8 10h8"/><path d="M8 14h4"/></svg>
                                Baggage (kg)
                            </label>
                            <input type="number" id="baggage" value="90" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="cockpitStorage" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M21 10V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h7"/><path d="M18 21a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="m15 15-2-2 4-4 2 2-4 4Z"/></svg>
                                Cockpit Storage (kg)
                            </label>
                            <input type="number" id="cockpitStorage" placeholder="0" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="cabinStorage" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                                Cabin Storage (kg)
                            </label>
                            <input type="number" id="cabinStorage" placeholder="0" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                    </div>
                </div>

                <!-- Flight Calculation Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Flight Calculation</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="tripTimeHours" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Trip Time
                            </label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="tripTimeHours" placeholder="hr" class="time-input bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                                <input type="number" id="tripTimeMinutes" placeholder="min" class="time-input bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="tripToAlternateHours" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Trip to Alternate
                            </label>
                             <div class="flex items-center space-x-2">
                                <input type="number" id="tripToAlternateHours" placeholder="hr" class="time-input bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                                <input type="number" id="tripToAlternateMinutes" placeholder="min" class="time-input bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="altitude" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                                Altitude (ft)
                            </label>
                            <input type="number" id="altitude" placeholder="0" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="airspeed" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>
                                Airspeed (kts)
                            </label>
                            <input type="number" id="airspeed" value="450" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                         <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="headwind" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M17.7 7.7a2.5 2.5 0 1 1-5 0"/><path d="M12 5v14"/><path d="M18 8.6a2.5 2.5 0 1 0-5 0"/><path d="M7 15h1"/><path d="M4.5 12.5h1"/><path d="M10 17.5h1"/></svg>
                                Headwind (kts)
                            </label>
                            <input type="number" id="headwind" placeholder="0" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <label for="fuelOnBoard" class="flex items-center text-sm font-medium">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H7"/></svg>
                                Fuel on Board (lbs)
                            </label>
                            <input type="number" id="fuelOnBoard" placeholder="0" class="w-28 bg-gray-700 text-white text-right font-semibold rounded-md p-1 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        </div>
                        <div class="flex justify-between items-baseline bg-gray-800 p-3 rounded-lg">
                            <span class="text-sm font-medium text-gray-300">Maximum Range</span>
                            <div>
                                <span id="maxRange" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">nm</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fuel Required Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Fuel Required (lbs)</h2>
                    <div class="space-y-4 bg-gray-800 p-4 rounded-lg">
                         <div class="flex items-center justify-between">
                            <label for="fuelConsumption" class="flex items-center text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-gray-400"><path d="M14 8a2 2 0 1 0-4 0v4a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V8z"/><path d="M8.5 14.5 7 20"/><path d="M15.5 14.5 17 20"/><path d="M4 14h16"/><path d="M4 14a4 4 0 0 1-1.3-7.8A4 4 0 0 1 6.3 4.2 4 4 0 0 1 10 6"/><path d="M20 14a4 4 0 0 0 1.3-7.8 4 4 0 0 0-3.6-2 4 4 0 0 0-3.7 1.8"/></svg>
                                Fuel Consumption
                            </label>
                            <div>
                                <input type="number" id="fuelConsumption" readonly class="w-28 bg-gray-600 text-white text-right font-semibold rounded-md p-1 border border-gray-600">
                                 <span class="text-sm text-gray-400">lbs/hr</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Trip Fuel</span>
                            <div>
                                <span id="fuelTripRequired" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                         <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Alternate Fuel</span>
                            <div>
                                <span id="alternateFuel" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Final Reserve 30 min</span>
                            <div>
                                <span id="reserveFuel" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Contingency (10%)</span>
                            <div>
                                <span id="contingencyFuel" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Start & Taxi</span>
                            <div>
                                <span id="startTaxiFuel" class="font-bold text-lg text-white">400</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline border-t border-gray-600 pt-3 mt-2">
                            <span class="text-sm font-semibold text-amber-400">TOTAL FUEL REQUIRED</span>
                            <div>
                                <span id="totalFuelRequired" class="font-bold text-xl text-amber-400">0</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seat Layout Configuration -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Seat Layout Configuration (kg)</h2>
                    <div class="bg-gray-800 p-4 rounded-lg space-y-4">
                        <!-- Cockpit -->
                        <div class="text-center text-xs text-gray-400 mb-2">-- COCKPIT --</div>
                        <div class="flex justify-around items-center">
                            <div class="seat">Pilot<br><span id="pilotSeatWt" class="font-bold text-amber-400">0</span> kg</div>
                            <div class="seat">Copilot<br><span id="copilotSeatWt" class="font-bold text-amber-400">0</span> kg</div>
                        </div>
                        <div class="flex justify-center mt-2">
                            <div class="seat">Jumpseat<br><span id="jumpseatWt" class="font-bold text-amber-400">0</span> kg</div>
                        </div>

                        <!-- Cabin -->
                        <div class="text-center text-xs text-gray-400 mt-4 mb-2">-- CABIN --</div>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Left Column -->
                            <div class="space-y-3 flex flex-col items-center">
                                 <div class="seat invisible">&nbsp;</div>
                                 <div class="seat invisible">&nbsp;</div>
                                 <div class="seat">S3<br><input type="number" id="seat3" placeholder="0" class="seat-input"></div>
                                 <div class="table-box my-2 invisible"></div>
                                 <div class="seat">S4<br><input type="number" id="seat4" placeholder="0" class="seat-input"></div>
                                 <div class="seat">S6<br><input type="number" id="seat6" placeholder="0" class="seat-input"></div>
                                 <div class="table-box my-2"></div>
                                 <div class="seat">S8<br><input type="number" id="seat8" placeholder="0" class="seat-input"></div>
                                 <div class="seat invisible mt-3">&nbsp;</div>
                                 <div class="seat invisible">&nbsp;</div>
                                 <div class="seat invisible">&nbsp;</div>
                                 <div class="component invisible w-full mt-3">&nbsp;</div>
                            </div>
                            <!-- Right Column -->
                            <div class="space-y-3 flex flex-col items-center">
                                <div class="seat">Galley<br><input type="number" id="galley" value="34" class="seat-input mt-1"></div>
                                <div class="seat">S1<br><input type="number" id="seat1" value="23" class="seat-input mt-1"></div>
                                <div class="seat">S2<br><input type="number" id="seat2" placeholder="0" class="seat-input"></div>
                                <div class="table-box my-2"></div>
                                <div class="seat">S5<br><input type="number" id="seat5" placeholder="0" class="seat-input"></div>
                                <div class="seat">S7<br><input type="number" id="seat7" placeholder="0" class="seat-input"></div>
                                <div class="table-box my-2"></div>
                                <div class="seat">S9<br><input type="number" id="seat9" placeholder="0" class="seat-input"></div>
                                <div class="seat mt-3">S10<br><input type="number" id="seat10" placeholder="0" class="seat-input"></div>
                                <div class="seat">S11<br><input type="number" id="seat11" placeholder="0" class="seat-input"></div>
                                <div class="seat">S12<br><input type="number" id="seat12" placeholder="0" class="seat-input"></div>
                                <div class="component w-full mt-3">Aft Lav<br><input type="number" id="aftLavatory" value="23" class="seat-input mt-1"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div class="flex flex-col items-center space-y-3">
                                <div class="table-box"></div>
                                <div class="seat">S13<br><input type="number" id="seat13" placeholder="0" class="seat-input"></div>
                            </div>
                             <div class="flex flex-col items-center">
                                <!-- This is an empty column for alignment -->
                             </div>
                        </div>
                         <!-- Baggage Area -->
                        <div class="text-center text-xs text-gray-400 mt-4 mb-2">-- BAGGAGE --</div>
                        <div class="component w-full bg-green-800 border-green-600">
                            Baggage: <span id="baggageLayoutWt" class="font-bold text-white">0</span> kg
                        </div>
                    </div>
                </div>

                <!-- Weight & CG Calculation -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Weight & CG Calculation</h2>
                    <div class="bg-gray-800 p-2 sm:p-4 rounded-lg overflow-x-auto">
                        <table class="w-full cg-table">
                            <thead class="border-b border-gray-600">
                                <tr>
                                    <th class="w-2/5">Item</th>
                                    <th>Weight (lbs)</th>
                                    <th>Arm (in)</th>
                                    <th>Moment</th>
                                    <th>%MAC</th>
                                </tr>
                            </thead>
                            <tbody id="cg-table-body">
                                <!-- Rows will be dynamically inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Weight & CG Envelope -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Weight & CG Envelope</h2>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <canvas id="cgEnvelopeChart"></canvas>
                    </div>
                </div>


                <!-- Weight Summary Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Weight Summary</h2>
                    <div class="space-y-4 bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Total Payload</span>
                            <div>
                                <span id="totalPayloadLbs" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">lbs / </span>
                                <span id="totalPayloadKg" class="font-bold text-lg text-white">0</span>
                                <span class="text-sm text-gray-400">kg</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Zero Fuel Weight (ZFW)</span>
                            <div>
                                <span id="zfwResult" class="font-bold text-xl text-amber-400">0</span>
                                <span class="text-sm text-gray-400">lbs / </span>
                                <span id="zfwMacResult" class="font-bold text-xl text-amber-400">0.00</span>
                                <span class="text-sm text-gray-400">%MAC</span>
                                <span id="zfwStatus" class="ml-2 text-sm font-semibold"></span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Takeoff Weight (TOW)</span>
                            <div>
                                <span id="towResult" class="font-bold text-xl text-amber-400">0</span>
                                <span class="text-sm text-gray-400">lbs / </span>
                                <span id="towMacResult" class="font-bold text-xl text-amber-400">0.00</span>
                                <span class="text-sm text-gray-400">%MAC</span>
                                <span id="towStatus" class="ml-2 text-sm font-semibold"></span>
                            </div>
                        </div>
                         <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Landing Weight (LW)</span>
                            <div>
                                <span id="landingWeightResult" class="font-bold text-xl text-amber-400">0</span>
                                <span class="text-sm text-gray-400">lbs / </span>
                                <span id="landingWeightMacResult" class="font-bold text-xl text-amber-400">0.00</span>
                                <span class="text-sm text-gray-400">%MAC</span>
                                <span id="landingWeightStatus" class="ml-2 text-sm font-semibold"></span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Extra Fuel</span>
                            <div>
                                <span id="extraFuelResult" class="font-bold text-lg text-green-400">0</span>
                                <span class="text-sm text-gray-400">lbs</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline border-t border-gray-700 pt-3 mt-3">
                            <span class="text-sm font-medium text-gray-300">Elevator Trim Tab Setting</span>
                            <div>
                                <span id="elevatorTrimResult" class="font-bold text-lg text-green-400">N/A</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline border-t border-gray-700 pt-3 mt-3">
                            <span class="text-sm font-medium text-gray-300">Available Payload</span>
                            <div>
                                <span id="availablePayloadLbs" class="font-bold text-lg text-green-400">0</span>
                                <span class="text-sm text-gray-400">lbs / </span>
                                <span id="availablePayloadKg" class="font-bold text-lg text-green-400">0</span>
                                <span class="text-sm text-gray-400">kg</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-medium text-gray-300">Available Passengers (@80kg)</span>
                            <div>
                                <span id="availablePassengers" class="font-bold text-lg text-green-400">0</span>
                                <span class="text-sm text-gray-400">pax</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer with PDF Button -->
            <footer class="text-center mt-8 pb-4">
                <button id="downloadPdfBtn" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-2 px-4 rounded-lg mb-4">
                    Download as PDF
                </button>
                <p id="pdf-message" class="text-sm text-amber-400 mb-4 hidden">Generating PDF...</p>
            </footer>

        </div>
    </div>
    
    <datalist id="pic-names">
        <option value="Capt. Susetyo Harijanto">
        <option value="Capt. Purwoko">
    </datalist>
    <datalist id="copilot-names">
        <option value="Capt. Susetyo Harijanto">
        <option value="Capt. Purwoko">
    </datalist>
    <datalist id="engineer-names">
        <option value="Diki Hariadi">
        <option value="Lazarus Rio">
        <option value="Prayit Susonko">
    </datalist>
    <datalist id="cabin-service-names">
        <option value="Qorry Maulidya">
        <option value="Tiffany Prisilia H">
        <option value="Agustin Zulfani">
        <option value="Nadya Casey Ivanka">
    </datalist>


    <script>
        // --- USERS & EXPIRY ---
        const users = {
            'harijantosusetyo@gmail.com': { password: 'user1', role: 'user' },
            'purwoko.mulyono@yahoo.com': { password: 'user2', role: 'user' },
            'admin@twa.com': { password: 'admin321', role: 'admin' }
        };
        
        // --- GOOGLE APPS SCRIPT URL ---
        // !!! PENTING: Ganti URL di bawah ini dengan URL Web App Anda dari Langkah 3 panduan.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw22S6RP2nFFAswYzLs1mlpJwW3jOutMGl80o7aVdiMRw9WqFww9uvvTRPiAGNmWjlv4Q/exec'; 

        // --- PAGE ELEMENTS ---
        const loginPage = document.getElementById('login-page');
        const appPage = document.getElementById('app-page');
        const adminPage = document.getElementById('admin-page');
        const expiredPage = document.getElementById('expired-page');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const expiryDateInput = document.getElementById('expiry-date-input');
        const saveExpiryBtn = document.getElementById('save-expiry-btn');
        const adminMessage = document.getElementById('admin-message');
        const appLogoutBtn = document.getElementById('app-logout-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');

        // --- LOGIN & EXPIRY LOGIC ---
        let appExpiryDate = null; // Variabel global untuk menyimpan tanggal

        async function getExpiryDate() {
            if (appExpiryDate) return appExpiryDate;
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                appExpiryDate = data.expiryDate;
                return appExpiryDate;
            } catch (error) {
                console.error("Gagal mengambil tanggal kedaluwarsa:", error);
                // Fallback jika gagal fetch
                return new Date().toISOString().split('T')[0]; 
            }
        }
        
        async function checkExpiry() { 
            const expiryDateStr = await getExpiryDate();
            if (!expiryDateStr) return true; // Anggap expired jika gagal fetch
            const expiryDate = new Date(expiryDateStr); 
            const today = new Date(); 
            today.setHours(0, 0, 0, 0); 
            return today > expiryDate; 
        }

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = 'Checking credentials...';
            loginError.classList.remove('hidden');

            const username = usernameInput.value;
            const password = passwordInput.value;
            const user = users[username];

            if (user && user.password === password) {
                const isExpired = await checkExpiry();
                if (isExpired && user.role !== 'admin') {
                    loginPage.classList.add('hidden');
                    expiredPage.classList.remove('hidden');
                } else {
                    if (user.role === 'admin') {
                        loginPage.classList.add('hidden');
                        adminPage.classList.remove('hidden');
                        const expiryDate = await getExpiryDate();
                        expiryDateInput.value = expiryDate;
                    } else {
                        loginPage.classList.add('hidden');
                        appPage.classList.remove('hidden');
                        initializeCgEnvelope();
                        calculateAll();
                        updateExpiryCountdown();
                    }
                }
            } else {
                loginError.textContent = 'Invalid username or password.';
                loginError.classList.remove('hidden');
            }
        }
        
        function handleLogout() { 
            loginPage.classList.remove('hidden'); 
            appPage.classList.add('hidden'); 
            adminPage.classList.add('hidden'); 
            expiredPage.classList.add('hidden'); 
            loginForm.reset(); 
            loginError.classList.add('hidden'); 
        }

        async function handleSaveExpiry() {
            const newDate = expiryDateInput.value;
            if (newDate) {
                adminMessage.textContent = 'Saving...';
                adminMessage.classList.remove('hidden', 'text-red-400', 'text-green-400');
                
                try {
                    const response = await fetch(`${SCRIPT_URL}?date=${newDate}`, {
                        method: 'POST',
                        mode: 'no-cors' // Diperlukan karena respons dari doPost sederhana
                    });
                    
                    // Karena 'no-cors', kita tidak bisa membaca responsnya, tapi kita asumsikan berhasil.
                    appExpiryDate = newDate; // Update cache lokal
                    adminMessage.textContent = 'Expiry date saved successfully!';
                    adminMessage.classList.add('text-green-400');
                    
                } catch (error) {
                    console.error("Gagal menyimpan tanggal:", error);
                    adminMessage.textContent = 'Failed to save date. Check console for errors.';
                    adminMessage.classList.add('text-red-400');
                } finally {
                    setTimeout(() => adminMessage.classList.add('hidden'), 4000);
                }
            }
        }

        async function updateExpiryCountdown() {
            const expiryDateStr = await getExpiryDate();
            if (!expiryDateStr) return;

            document.getElementById('expiry-date-display').textContent = `This Application is valid until ${new Date(expiryDateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })}`;
            const expiryDate = new Date(expiryDateStr);
            expiryDate.setDate(expiryDate.getDate() + 1);
            const currentDate = new Date();
            const timeDiff = expiryDate.getTime() - currentDate.getTime();
            const daysLeft = Math.floor(timeDiff / (1000 * 3600 * 24));
            const countdownElement = document.getElementById('expiry-countdown');
            if (daysLeft >= 0) {
                countdownElement.textContent = `Remaining validity: ${daysLeft} days`;
                countdownElement.classList.remove('text-red-400');
                countdownElement.classList.add('text-amber-400');
            } else {
                countdownElement.textContent = 'Application Expired';
                countdownElement.classList.remove('text-amber-400');
                countdownElement.classList.add('text-red-400');
            }
        }

        // --- HELPER FUNCTIONS ---
        const kgToLbs = (kg) => (kg || 0) * KG_TO_LBS;
        const calculateMoment = (weight, arm) => (weight || 0) * (arm || 0);
        const getMacFromTable = (arm) => { if (!arm || arm < 430 || arm >= 471) return 0; const armInt = Math.floor(arm); const armDecIndex = Math.round((arm - armInt) * 10); const row = MAC_TABLE[armInt]; if (row && row[armDecIndex] !== undefined) return row[armDecIndex]; return 0; };
        const getElevatorTrimSetting = (zfwMac, fuelOnBoard) => { const fuelKey = Math.max(1000, Math.min(29000, Math.round(fuelOnBoard / 1000) * 1000)); const macKey = Math.max(36, Math.min(45, Math.round(zfwMac))); const fuelRow = ELEVATOR_TRIM_TABLE[fuelKey]; if (fuelRow) { const trimSetting = fuelRow[macKey]; if (trimSetting !== undefined) return trimSetting; } return "N/A"; };

        // --- CORE CALCULATION FUNCTION ---
        function calculateAll() {
            const pilotKg = parseFloat(inputs.pilot.value) || 0; const copilotKg = parseFloat(inputs.copilot.value) || 0; const engineerKg = parseFloat(inputs.engineer.value) || 0; const cabinServiceKg = parseFloat(inputs.cabinService.value) || 0; const baggageKg = parseFloat(inputs.baggage.value) || 0; const cockpitStorageKg = parseFloat(inputs.cockpitStorage.value) || 0; const cabinStorageKg = parseFloat(inputs.cabinStorage.value) || 0;
            const seatPayloadsKg = { galley: parseFloat(inputs.galley.value) || 0, seat1: parseFloat(inputs.seat1.value) || 0, seat2: parseFloat(inputs.seat2.value) || 0, seat3: parseFloat(inputs.seat3.value) || 0, seat4: parseFloat(inputs.seat4.value) || 0, seat5: parseFloat(inputs.seat5.value) || 0, seat6: parseFloat(inputs.seat6.value) || 0, seat7: parseFloat(inputs.seat7.value) || 0, seat8: parseFloat(inputs.seat8.value) || 0, seat9: parseFloat(inputs.seat9.value) || 0, seat10: parseFloat(inputs.seat10.value) || 0, seat11: parseFloat(inputs.seat11.value) || 0, seat12: parseFloat(inputs.seat12.value) || 0, seat13: parseFloat(inputs.seat13.value) || 0, aftLavatory: parseFloat(inputs.aftLavatory.value) || 0, };
            const totalSeatPayloadKg = Object.values(seatPayloadsKg).reduce((sum, val) => sum + val, 0);
            const maxTowLimit = parseFloat(inputs.maxTakeoffWeight.value) || 0; const maxZfwLimit = 49000; const emptyWeight = parseFloat(inputs.emptyWeight.value) || 0;
            const tripTimeHours = parseFloat(inputs.tripTimeHours.value) || 0; const tripTimeMinutes = parseFloat(inputs.tripTimeMinutes.value) || 0; const currentAltitude = parseFloat(inputs.altitude.value) || 0; 
            const altitudeDifference = currentAltitude - BASE_ALTITUDE; const altitudeAdjustment = (altitudeDifference / 1000) * ALTITUDE_ADJUSTMENT_FACTOR; const adjustedFuelBurn = BASE_FUEL_BURN * (1 - altitudeAdjustment);
            inputs.fuelConsumption.value = adjustedFuelBurn.toFixed(1);
            const totalTripTimeInHours = tripTimeHours + (tripTimeMinutes / 60); const calculatedTripFuel = totalTripTimeInHours * adjustedFuelBurn;
            const airspeed = parseFloat(inputs.airspeed.value) || 0; const headwind = parseFloat(inputs.headwind.value) || 0; const fuelOnBoard = parseFloat(inputs.fuelOnBoard.value) || 0;
            const totalPayloadKg = pilotKg + copilotKg + engineerKg + cabinServiceKg + baggageKg + cockpitStorageKg + cabinStorageKg + totalSeatPayloadKg; const totalPayloadLbs = totalPayloadKg * KG_TO_LBS;
            const cgData = { emptyWeight: { weight: emptyWeight, arm: ARMS.emptyWeight }, crew: { weight: kgToLbs(pilotKg + copilotKg), arm: ARMS.crew }, cockpitStorage: { weight: kgToLbs(cockpitStorageKg), arm: ARMS.cockpitStorage }, galley: { weight: kgToLbs(seatPayloadsKg.galley), arm: ARMS.galley }, aftLavatory: { weight: kgToLbs(seatPayloadsKg.aftLavatory), arm: ARMS.aftLavatory }, crewBaggage: { weight: kgToLbs(cabinServiceKg), arm: ARMS.crewBaggage }, jumpSeat: { weight: kgToLbs(engineerKg), arm: ARMS.jumpSeat }, cabinStorage: { weight: kgToLbs(cabinStorageKg), arm: ARMS.cabinStorage }, seat1: { weight: kgToLbs(seatPayloadsKg.seat1), arm: ARMS.seat1 }, seat2: { weight: kgToLbs(seatPayloadsKg.seat2), arm: ARMS.seat2 }, seat3: { weight: kgToLbs(seatPayloadsKg.seat3), arm: ARMS.seat3 }, seat4: { weight: kgToLbs(seatPayloadsKg.seat4), arm: ARMS.seat4 }, seat5: { weight: kgToLbs(seatPayloadsKg.seat5), arm: ARMS.seat5 }, seat6: { weight: kgToLbs(seatPayloadsKg.seat6), arm: ARMS.seat6 }, seat7: { weight: kgToLbs(seatPayloadsKg.seat7), arm: ARMS.seat7 }, seat8: { weight: kgToLbs(seatPayloadsKg.seat8), arm: ARMS.seat8 }, seat9: { weight: kgToLbs(seatPayloadsKg.seat9), arm: ARMS.seat9 }, seat10: { weight: kgToLbs(seatPayloadsKg.seat10), arm: ARMS.seat10 }, seat11: { weight: kgToLbs(seatPayloadsKg.seat11), arm: ARMS.seat11 }, seat12: { weight: kgToLbs(seatPayloadsKg.seat12), arm: ARMS.seat12 }, seat13: { weight: kgToLbs(seatPayloadsKg.seat13), arm: ARMS.seat13 }, baggage: { weight: kgToLbs(baggageKg), arm: ARMS.baggage }, fuel: { weight: fuelOnBoard, arm: ARMS.fuel }, tripFuel: { weight: -calculatedTripFuel, arm: ARMS.fuel }, };
            for (const key in cgData) { cgData[key].moment = calculateMoment(cgData[key].weight, cgData[key].arm); }
            const bowItems = ['emptyWeight', 'crew', 'cockpitStorage', 'galley', 'aftLavatory', 'crewBaggage', 'jumpSeat', 'cabinStorage']; const paxItems = ['seat1', 'seat2', 'seat3', 'seat4', 'seat5', 'seat6', 'seat7', 'seat8', 'seat9', 'seat10', 'seat11', 'seat12', 'seat13'];
            const calculateTotal = (items) => { const total = { weight: 0, moment: 0, arm: 0, mac: 0 }; items.forEach(key => { if (cgData[key]) { total.weight += cgData[key].weight; total.moment += cgData[key].moment; } }); total.arm = total.weight > 0 ? total.moment / total.weight : 0; return total; };
            const MAC_FORMULA_SLOPE = 0.6025; const MAC_FORMULA_INTERCEPT = -233.6508;
            const bowTotal = calculateTotal(bowItems); bowTotal.mac = MAC_FORMULA_SLOPE * bowTotal.arm + MAC_FORMULA_INTERCEPT;
            const paxTotal = calculateTotal(paxItems);
            const zfwTotal = { weight: bowTotal.weight + paxTotal.weight + cgData.baggage.weight, moment: bowTotal.moment + paxTotal.moment + cgData.baggage.moment, }; zfwTotal.arm = zfwTotal.weight > 0 ? zfwTotal.moment / zfwTotal.weight : 0; zfwTotal.mac = getMacFromTable(zfwTotal.arm);
            const towTotal = { weight: zfwTotal.weight + cgData.fuel.weight, moment: zfwTotal.moment + cgData.fuel.moment, }; towTotal.arm = towTotal.weight > 0 ? towTotal.moment / towTotal.weight : 0; towTotal.mac = MAC_FORMULA_SLOPE * towTotal.arm + MAC_FORMULA_INTERCEPT;
            const lwTotal = { weight: towTotal.weight + cgData.tripFuel.weight, moment: towTotal.moment + cgData.tripFuel.moment, }; lwTotal.arm = lwTotal.weight > 0 ? lwTotal.moment / lwTotal.weight : 0; lwTotal.mac = MAC_FORMULA_SLOPE * lwTotal.arm + MAC_FORMULA_INTERCEPT;
            updateCgTable(cgData, bowTotal, paxItems, zfwTotal, towTotal, lwTotal);
            updateSummariesAndFlightCalc(totalPayloadKg, totalPayloadLbs, zfwTotal, towTotal, lwTotal, maxZfwLimit, maxTowLimit, adjustedFuelBurn, airspeed, headwind, fuelOnBoard, calculatedTripFuel);
            updateCgEnvelope(zfwTotal, towTotal, lwTotal);
            outputs.pilotSeatWt.textContent = pilotKg.toFixed(0); outputs.copilotSeatWt.textContent = copilotKg.toFixed(0); outputs.jumpseatWt.textContent = engineerKg.toFixed(0); outputs.baggageLayoutWt.textContent = baggageKg.toFixed(0);
        }
        function updateCgTable(cgData, bowTotal, paxItems, zfwTotal, towTotal, lwTotal) { const format = (val, dec = 0) => val.toFixed(dec); const formatMoment = (val) => (val / 1000).toFixed(2); let html = ''; const createRow = (label, data, isTotal = false, showMac = false) => { const weight = data.weight; const arm = data.arm; const moment = data.moment; let mac = 0; if (showMac) mac = isTotal ? data.mac : getMacFromTable(arm); const rowClass = isTotal ? 'total-row' : 'border-b border-gray-700'; return `<tr class="${rowClass}"><td>${label}</td><td>${format(weight, 1)}</td><td>${arm > 0 ? format(arm, 1) : '-'}</td><td>${formatMoment(moment)}</td><td>${mac > 0 ? format(mac, 2) : '-'}</td></tr>`; }; const createEditableEmptyWeightRow = (data) => { const weight = data.weight; const arm = data.arm; const moment = data.moment; const mac = getMacFromTable(arm); return `<tr class="border-b border-gray-700"><td>Empty Weight</td><td>${format(weight, 1)}</td><td><input id="emptyWeightArmInput" type="number" value="${arm.toFixed(1)}" class="editable-cell-input"></td><td id="emptyWeightMomentCell">${formatMoment(moment)}</td><td><input id="emptyWeightMacInput" type="number" value="${mac.toFixed(1)}" class="editable-cell-input" readonly></td></tr>`; }; html += createEditableEmptyWeightRow(cgData.emptyWeight); html += createRow('Crew', cgData.crew); html += createRow('Cockpit Storage', cgData.cockpitStorage); html += createRow('Galley', cgData.galley); html += createRow('Aft Lavatory', cgData.aftLavatory); html += createRow('Crew Baggage', cgData.crewBaggage); html += createRow('Jump Seat', cgData.jumpSeat); html += createRow('Cabin Storage', cgData.cabinStorage); html += createRow('Basic Operating Weight (BOW)', bowTotal, true, true); html += `<tr><td class="pt-4 font-semibold">Passengers:</td></tr>`; paxItems.forEach(key => { if(cgData[key] && cgData[key].weight > 0) html += createRow(key.charAt(0).toUpperCase() + key.slice(1), cgData[key]); }); html += createRow('Baggage', cgData.baggage); html += createRow('Zero Fuel Weight (ZFW)', zfwTotal, true, true); html += createRow('Fuel', cgData.fuel); html += createRow('Take Off Weight (TOW)', towTotal, true, true); html += createRow('Landing Weight (LW)', lwTotal, true, true); outputs.cgTableBody.innerHTML = html; document.getElementById('emptyWeightArmInput').addEventListener('input', (e) => { ARMS.emptyWeight = parseFloat(e.target.value) || 0; calculateAll(); }); }
        function updateSummariesAndFlightCalc(totalPayloadKg, totalPayloadLbs, zfwTotal, towTotal, lwTotal, maxZfwLimit, maxTowLimit, fuelConsumption, airspeed, headwind, fuelOnBoard, tripFuel) { outputs.totalPayloadKg.textContent = totalPayloadKg.toFixed(0); outputs.totalPayloadLbs.textContent = totalPayloadLbs.toFixed(0); outputs.zfwResult.textContent = zfwTotal.weight.toFixed(0); outputs.zfwMacResult.textContent = zfwTotal.mac.toFixed(2); updateStatus(outputs.zfwStatus, zfwTotal.weight, maxZfwLimit); outputs.towResult.textContent = towTotal.weight.toFixed(0); outputs.towMacResult.textContent = towTotal.mac.toFixed(2); updateStatus(outputs.towStatus, towTotal.weight, maxTowLimit); outputs.landingWeightResult.textContent = lwTotal.weight.toFixed(0); outputs.landingWeightMacResult.textContent = lwTotal.mac.toFixed(2); updateStatus(outputs.landingWeightStatus, lwTotal.weight, 66000); const availablePayloadLbs = maxTowLimit - towTotal.weight; const availablePayloadKg = availablePayloadLbs / KG_TO_LBS; const availablePassengers = availablePayloadKg > 0 ? Math.floor(availablePayloadKg / 80) : 0; outputs.availablePayloadLbs.textContent = availablePayloadLbs.toFixed(0); outputs.availablePayloadKg.textContent = availablePayloadKg.toFixed(0); outputs.availablePassengers.textContent = availablePassengers; const groundSpeed = airspeed - headwind; const maxRange = (fuelConsumption > 0 && groundSpeed > 0 && fuelOnBoard > 0) ? (fuelOnBoard / fuelConsumption) * groundSpeed : 0; outputs.maxRange.textContent = maxRange.toFixed(0); const fuelPerMinute = fuelConsumption > 0 ? fuelConsumption / 60 : 0; const totalAlternateTimeMinutes = (parseFloat(inputs.tripToAlternateHours.value) || 0) * 60 + (parseFloat(inputs.tripToAlternateMinutes.value) || 0); const calculatedAlternateFuel = totalAlternateTimeMinutes * fuelPerMinute; const calculatedReserveFuel = 30 * fuelPerMinute; const calculatedContingencyFuel = tripFuel * 0.10; const calculatedStartTaxiFuel = 400; const totalFuelRequired = tripFuel + calculatedAlternateFuel + calculatedReserveFuel + calculatedContingencyFuel + calculatedStartTaxiFuel; const extraFuel = fuelOnBoard - totalFuelRequired; outputs.extraFuelResult.textContent = extraFuel.toFixed(0); outputs.elevatorTrimResult.textContent = getElevatorTrimSetting(zfwTotal.mac, fuelOnBoard); outputs.fuelTripRequired.textContent = tripFuel.toFixed(1); outputs.alternateFuel.textContent = calculatedAlternateFuel.toFixed(1); outputs.reserveFuel.textContent = calculatedReserveFuel.toFixed(1); outputs.contingencyFuel.textContent = calculatedContingencyFuel.toFixed(1); outputs.startTaxiFuel.textContent = calculatedStartTaxiFuel.toFixed(1); outputs.totalFuelRequired.textContent = totalFuelRequired.toFixed(1); }
        function updateStatus(element, value, limit) { element.classList.remove('text-green-500', 'text-red-500', 'text-yellow-400'); if (value <= 0) { element.textContent = 'Awaiting Input'; element.classList.add('text-yellow-400'); } else if (value > limit) { element.textContent = 'OVERWEIGHT'; element.classList.add('text-red-500'); } else { element.textContent = 'OK'; element.classList.add('text-green-500'); } }
        function initializeCgEnvelope() { const ctx = document.getElementById('cgEnvelopeChart').getContext('2d'); const envelopeData = [ {x: 38, y: 39400}, {x: 36.4, y: 45000}, {x: 36.4, y: 46500}, {x: 41.3, y: 46500}, {x: 45, y: 44000}, {x: 45, y: 38000}, {x: 42, y: 38000}, {x: 38, y: 39400} ]; cgChart = new Chart(ctx, { type: 'line', data: { datasets: [ { label: 'CG Envelope', data: envelopeData, borderColor: '#fcd34d', backgroundColor: 'rgba(252, 211, 77, 0.2)', fill: true, borderWidth: 2, pointRadius: 0, order: 10 }, { label: 'ZFW', data: [], backgroundColor: '#34d399', pointRadius: 6, pointHoverRadius: 8, type: 'scatter', order: 0 }, { label: 'TOW', data: [], backgroundColor: '#60a5fa', pointRadius: 6, pointHoverRadius: 8, type: 'scatter', order: 0 }, { label: 'LW', data: [], backgroundColor: '#f87171', pointRadius: 6, pointHoverRadius: 8, type: 'scatter', order: 0 } ] }, options: { responsive: true, aspectRatio: 1, scales: { x: { type: 'linear', position: 'bottom', min: 25, max: 51, title: { display: true, text: '% MAC', color: '#9ca3af' }, ticks: { color: '#9ca3af', stepSize: 1 }, grid: { color: 'rgba(156, 163, 175, 0.2)' } }, y: { min: 36000, max: 77000, title: { display: true, text: 'GROSS WEIGHT  LBS', color: '#9ca3af' }, ticks: { color: '#9ca3af', stepSize: 1000, callback: (value) => (value % 1000 === 0) ? value : null }, grid: { color: 'rgba(156, 163, 175, 0.2)' } } }, plugins: { legend: { labels: { color: '#d1d5db' } }, annotation: { annotations: { maxRamp: { type: 'line', yMin: 75000, yMax: 75000, borderColor: 'rgb(239, 68, 68, 0.7)', borderWidth: 2, label: { content: 'Max Ramp', enabled: true, position: 'start', backgroundColor: 'rgba(239, 68, 68, 0.7)' } }, maxTakeoff: { type: 'line', yMin: 74600, yMax: 74600, borderColor: 'rgb(249, 115, 22, 0.7)', borderWidth: 2, label: { content: 'Max Takeoff', enabled: true, position: 'start', backgroundColor: 'rgba(249, 115, 22, 0.7)' } }, maxLanding: { type: 'line', yMin: 66000, yMax: 66000, borderColor: 'rgb(59, 130, 246, 0.7)', borderWidth: 2, label: { content: 'Max Landing Weight', enabled: true, position: 'start', yAdjust: -15, backgroundColor: 'rgba(59, 130, 246, 0.7)' } }, aftForwardLoading: { type: 'line', xMin: 36.4, xMax: 43.5, yMin: 45000, yMax: 45000, borderColor: 'rgb(16, 185, 129, 0.7)', borderWidth: 2, borderDash: [5, 5], label: { content: 'aft to forward loading', enabled: true, position: 'center', yAdjust: -10, backgroundColor: 'rgba(0,0,0,0)', color: 'rgb(16, 185, 129, 0.9)' } } } } } } }); }
        function updateCgEnvelope(zfw, tow, lw) { if (!cgChart) return; cgChart.data.datasets[1].data = [{ x: zfw.mac, y: zfw.weight }]; cgChart.data.datasets[2].data = [{ x: tow.mac, y: tow.weight }]; cgChart.data.datasets[3].data = [{ x: lw.mac, y: lw.weight }]; cgChart.update(); }
        async function generateProfessionalPDF() {
            const pdfMessage = document.getElementById('pdf-message'); pdfMessage.classList.remove('hidden');
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('PT. TRANSWISATA PRIMA AVIATION', 105, 15, null, null, 'center'); doc.setFontSize(18); doc.text('Load Sheet Gulfstream IV SP', 105, 22, null, null, 'center'); doc.setFontSize(12); doc.setFont(undefined, 'normal'); doc.text(`Aircraft Registration: PK-TWY`, 105, 28, null, null, 'center'); doc.setFontSize(10); doc.text(`Date: ${new Date().toLocaleDateString('en-GB')}`, 105, 34, null, null, 'center');
            doc.autoTable({ startY: 40, head: [['Route Information', '']], body: [['From', inputs.routeFrom.value], ['Destination', inputs.routeTo.value],], theme: 'grid', headStyles: { fillColor: [45, 55, 72] }, });
            doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Role', 'Name']], body: [['PIC', inputs.picName.value], ['Copilot', inputs.copilotName.value], ['Engineer', inputs.engineerName.value], ['Cabin Service', inputs.cabinServiceName.value], ['Total Person on Board (POB)', inputs.totalPob.value],], theme: 'grid', headStyles: { fillColor: [22, 163, 74] }, });
            let finalY = doc.lastAutoTable.finalY;
            const tripTime = `${inputs.tripTimeHours.value || 0} hr ${inputs.tripTimeMinutes.value || 0} min`; const alternateTime = `${inputs.tripToAlternateHours.value || 0} hr ${inputs.tripToAlternateMinutes.value || 0} min`;
            doc.autoTable({ startY: finalY + 10, head: [['Flight Calculation', 'Value']], body: [['Trip Time', tripTime], ['Trip to Alternate', alternateTime], ['Altitude', `${inputs.altitude.value} ft`], ['Airspeed', `${inputs.airspeed.value} kts`], ['Headwind', `${inputs.headwind.value} kts`], ['Fuel on Board', `${inputs.fuelOnBoard.value} lbs`], ['Maximum Range', `${outputs.maxRange.textContent} nm`],], theme: 'grid', headStyles: { fillColor: [45, 55, 72] }, }); finalY = doc.lastAutoTable.finalY;
            doc.autoTable({ startY: finalY + 10, head: [['Fuel Required', 'Value']], body: [['Fuel Consumption', `${inputs.fuelConsumption.value} lbs/hr`], ['Trip Fuel', `${outputs.fuelTripRequired.textContent} lbs`], ['Alternate Fuel', `${outputs.alternateFuel.textContent} lbs`], ['Final Reserve 30 min', `${outputs.reserveFuel.textContent} lbs`], ['Contingency (10%)', `${outputs.contingencyFuel.textContent} lbs`], ['Start & Taxi', `${outputs.startTaxiFuel.textContent} lbs`], ['TOTAL FUEL REQUIRED', `${outputs.totalFuelRequired.textContent} lbs`],], theme: 'grid', headStyles: { fillColor: [45, 55, 72] }, bodyStyles: { fontStyle: 'bold' }, didParseCell: function(data) { if (data.row.index === 6) { data.cell.styles.fillColor = '#1f2937'; data.cell.styles.textColor = '#fcd34d'; } } }); finalY = doc.lastAutoTable.finalY;
            const table = document.getElementById('cg-table-body'); let bodyData = []; table.querySelectorAll('tr').forEach(row => { let rowData = []; row.querySelectorAll('td').forEach(cell => { let cellText = cell.querySelector('input') ? cell.querySelector('input').value : cell.innerText; rowData.push(cellText); }); bodyData.push(rowData); });
            if (finalY + 20 > doc.internal.pageSize.getHeight() - 30) { doc.addPage(); finalY = 10; }
            doc.autoTable({ startY: finalY + 10, head: [['Item', 'Weight (lbs)', 'Arm (in)', 'Moment', '%MAC']], body: bodyData, theme: 'striped', headStyles: { fillColor: [45, 55, 72] }, styles: { fontSize: 8 }, columnStyles: { 0: { cellWidth: 60 }, 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' }, 4: { halign: 'right' }, }, didParseCell: function(data) { const originalTable = document.getElementById('cg-table-body'); const originalRow = originalTable.querySelectorAll('tr')[data.row.index]; if (originalRow && originalRow.classList.contains('total-row')) { data.cell.styles.fillColor = '#1f2937'; data.cell.styles.textColor = '#fcd34d'; data.cell.styles.fontStyle = 'bold'; } } }); finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Elevator Trim Tab Setting:', 14, finalY + 10); doc.setFont(undefined, 'normal'); doc.text(outputs.elevatorTrimResult.textContent, 65, finalY + 10);
            const chartCanvas = document.getElementById('cgEnvelopeChart'); const chartImage = chartCanvas.toDataURL('image/png', 1.0); const chartWidth = 80; const chartHeight = 80; const chartX = (doc.internal.pageSize.getWidth() - chartWidth) / 2;
            if (finalY + 20 + chartHeight > doc.internal.pageSize.getHeight() - 30) { doc.addPage(); finalY = 10; }
            doc.addImage(chartImage, 'PNG', chartX, finalY + 20, chartWidth, chartHeight);
            const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); const pageHeight = doc.internal.pageSize.getHeight(); const pageWidth = doc.internal.pageSize.getWidth(); if (i === pageCount) { const picName = inputs.picName.value || '_________________________'; doc.text(picName, 14, pageHeight - 30); doc.line(14, pageHeight - 25, 80, pageHeight - 25); doc.text('Pilot in Command Signature', 14, pageHeight - 20); } doc.setFontSize(10); doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' }); }
            doc.save('G-IV_SP_PK-TWY_Weight_Balance.pdf'); pdfMessage.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---
        Object.values(inputs).forEach(input => { if (input) { input.addEventListener('input', calculateAll); input.addEventListener('focus', (e) => { if (e.target.value !== '0' && e.target.value !== '') { e.target.dataset.originalValue = e.target.value; e.target.value = ''; } else if (e.target.value === '0') { e.target.dataset.originalValue = '0'; e.target.value = ''; } }); input.addEventListener('blur', (e) => { if (e.target.value === '' && e.target.dataset.originalValue) { e.target.value = e.target.dataset.originalValue; } else if (e.target.value === '' && !e.target.dataset.originalValue) { if (e.target.placeholder === '0' || e.target.value === '') { e.target.value = '0'; } } calculateAll(); }); } });
        loginForm.addEventListener('submit', handleLogin);
        appLogoutBtn.addEventListener('click', handleLogout);
        adminLogoutBtn.addEventListener('click', handleLogout);
        saveExpiryBtn.addEventListener('click', handleSaveExpiry);
        document.getElementById('downloadPdfBtn').addEventListener('click', generateProfessionalPDF);

    </script>
</body>
</html>